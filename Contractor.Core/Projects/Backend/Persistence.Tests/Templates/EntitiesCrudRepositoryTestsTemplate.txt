using ProjectName.Contract.Contexts;
using ProjectName.Contract.Persistence.Modules.Domain.Entities;
using ProjectName.Contract.Persistence.Tools.Pagination;
using ProjectName.Persistence.Modules.Domain.Entities;
using Microsoft.VisualStudio.TestTools.UnitTesting;
using Moq;
using System;
using System.Linq;

namespace ProjectName.Persistence.Tests.Modules.Domain.Entities
{
    [TestClass]
    public class EntitiesCrudRepositoryTests
    {
        [TestMethod]
        public void CreateEntityTest()
        {
            // Arrange
            EntitiesCrudRepository entitiesCrudRepository = this.GetEntitiesCrudRepositoryEmpty();

            // Act
            entitiesCrudRepository.CreateEntity(DbEntityTest.ForCreate());

            // Assert
            IDbEntity dbEntity = entitiesCrudRepository.GetEntity(EntityTestValues.IdForCreate);
            DbEntityTest.AssertForCreate(dbEntity);
        }

        [TestMethod]
        public void DeleteEntityTest()
        {
            // Arrange
            EntitiesCrudRepository entitiesCrudRepository = this.GetEntitiesCrudRepositoryDefault();

            // Act
            entitiesCrudRepository.DeleteEntity(EntityTestValues.IdDbDefault);

            // Assert
            bool doesEntityExist = entitiesCrudRepository.DoesEntityExist(EntityTestValues.IdDbDefault);
            Assert.IsFalse(doesEntityExist);
        }

        [TestMethod]
        public void DoesEntityExistFalseTest()
        {
            // Arrange
            EntitiesCrudRepository entitiesCrudRepository = this.GetEntitiesCrudRepositoryEmpty();

            // Act
            bool doesEntityExist = entitiesCrudRepository.DoesEntityExist(EntityTestValues.IdDbDefault);

            // Assert
            Assert.IsFalse(doesEntityExist);
        }

        [TestMethod]
        public void DoesEntityExistTrueTest()
        {
            // Arrange
            EntitiesCrudRepository entitiesCrudRepository = this.GetEntitiesCrudRepositoryDefault();

            // Act
            bool doesEntityExist = entitiesCrudRepository.DoesEntityExist(EntityTestValues.IdDbDefault);

            // Assert
            Assert.IsTrue(doesEntityExist);
        }

        [TestMethod]
        public void GetEntityDefaultTest()
        {
            // Arrange
            EntitiesCrudRepository entitiesCrudRepository = this.GetEntitiesCrudRepositoryDefault();

            // Act
            IDbEntity dbEntity = entitiesCrudRepository.GetEntity(EntityTestValues.IdDbDefault);

            // Assert
            DbEntityTest.AssertDbDefault(dbEntity);
        }

        [TestMethod]
        public void GetEntityDetailDefaultTest()
        {
            // Arrange
            EntitiesCrudRepository entitiesCrudRepository = this.GetEntitiesCrudRepositoryDefault();

            // Act
            IDbEntityDetail dbEntityDetail = entitiesCrudRepository.GetEntityDetail(EntityTestValues.IdDbDefault);

            // Assert
            DbEntityDetailTest.AssertDbDefault(dbEntityDetail);
        }

        [TestMethod]
        public void GetEntityDetailNullTest()
        {
            // Arrange
            EntitiesCrudRepository entitiesCrudRepository = this.GetEntitiesCrudRepositoryEmpty();

            // Act
            IDbEntityDetail dbEntityDetail = entitiesCrudRepository.GetEntityDetail(EntityTestValues.IdDbDefault);

            // Assert
            Assert.IsNull(dbEntityDetail);
        }

        [TestMethod]
        public void GetAllEntitiesDefaultTest()
        {
            // Arrange
            EntitiesCrudRepository entitiesCrudRepository = this.GetEntitiesCrudRepositoryDefault();

            // Act
            IDbEntity[] dbEntities = entitiesCrudRepository.GetAllEntities().ToArray();

            // Assert
            Assert.AreEqual(2, dbEntities.Length);
            DbEntityTest.AssertDbDefault(dbEntities[0]);
            DbEntityTest.AssertDbDefault2(dbEntities[1]);
        }

        [TestMethod]
        public void GetEntitiesDefaultTest()
        {
            // Arrange
            EntitiesCrudRepository entitiesCrudRepository = this.GetEntitiesCrudRepositoryDefault();

            // Act
            IDbPagedResult<IDbEntity> dbEntitiesPagedResult =
                entitiesCrudRepository.GetEntities();

            // Assert
            IDbEntity[] dbEntities = dbEntitiesPagedResult.Data.ToArray();
            Assert.AreEqual(2, dbEntities.Length);
            DbEntityTest.AssertDbDefault(dbEntities[0]);
            DbEntityTest.AssertDbDefault2(dbEntities[1]);
        }

        [TestMethod]
        public void GetEntityNullTest()
        {
            // Arrange
            EntitiesCrudRepository entitiesCrudRepository = this.GetEntitiesCrudRepositoryEmpty();

            // Act
            IDbEntity dbEntity = entitiesCrudRepository.GetEntity(EntityTestValues.IdDbDefault);

            // Assert
            Assert.IsNull(dbEntity);
        }

        [TestMethod]
        public void UpdateEntityTest()
        {
            // Arrange
            EntitiesCrudRepository entitiesCrudRepository = this.GetEntitiesCrudRepositoryDefault();

            // Act
            entitiesCrudRepository.UpdateEntity(DbEntityTest.ForUpdate());

            // Assert
            IDbEntity dbEntity = entitiesCrudRepository.GetEntity(EntityTestValues.IdDbDefault);
            DbEntityTest.AssertForUpdate(dbEntity);
        }

        private EntitiesCrudRepository GetEntitiesCrudRepositoryDefault()
        {
            return new EntitiesCrudRepository(
                this.GetPaginationContext(),
                InMemoryDbContext.CreatePersistenceDbContextWithDefault());
        }

        private EntitiesCrudRepository GetEntitiesCrudRepositoryEmpty()
        {
            return new EntitiesCrudRepository(
                this.GetPaginationContext(),
                InMemoryDbContext.CreatePersistenceDbContext());
        }

        private IPaginationContext GetPaginationContext()
        {
            Mock<IPaginationContext> paginationContext = new Mock<IPaginationContext>();
            paginationContext.Setup(context => context.Limit).Returns(10);
            paginationContext.Setup(context => context.Offset).Returns(0);
            paginationContext.Setup(context => context.Sort).Returns(Array.Empty<IPaginationSortItem>());
            paginationContext.Setup(context => context.Filter).Returns(Array.Empty<IPaginationFilterItem>());
            return paginationContext.Object;
        }
    }
}